<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="format-detection" content="telephone=no">
<title>äº‘ç«¯ä¾¿ç­¾</title>
<style>
/* çº¯åŸºç¡€CSSï¼Œå…¼å®¹iOS12è€æµè§ˆå™¨ */
* {margin:0;padding:0;border:0;box-sizing:border-box;}
body {font-family:Arial,"PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;background:#f7f8fa;padding:15px;min-height:100vh;}
.header {margin-bottom:15px;text-align:center;}
.page-btn {display:inline-block;padding:8px 14px;margin:0 5px 8px 5px;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);font-size:15px;color:#333;cursor:pointer;}
.page-btn.active {background:#5191ff;color:#fff;}
.sync-btn {background:#51c351;color:#fff!important;}
.token-box {width:100%;max-width:600px;margin:0 auto 10px auto;}
#token {width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;font-size:14px;color:#333;background:#fff;}
#token::placeholder {color:#999;}
.editor {width:100%;max-width:600px;margin:0 auto;background:#fff;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1);padding:15px;}
#note {width:100%;height:380px;font-size:16px;line-height:1.6;color:#333;background:transparent;outline:none;resize:none;}
#note::placeholder {color:#999;}
.status {margin-top:10px;text-align:center;font-size:14px;color:#666;}
</style>
</head>
<body>

<div class="header">
  <button class="page-btn active" data-page="1">ç¬¬1é¡µ</button>
  <button class="page-btn" data-page="2">ç¬¬2é¡µ</button>
  <button class="page-btn" data-page="3">ç¬¬3é¡µ</button>
  <button class="page-btn sync-btn">â˜ï¸ åŒæ­¥</button>
</div>

<div class="token-box">
  <input id="token" placeholder="è¾“å…¥GitHub Tokenï¼ˆäº‘ç«¯åŒæ­¥ç”¨ï¼‰">
</div>

<div class="editor">
  <textarea id="note" placeholder="åœ¨è¿™é‡Œå†™ä¾¿ç­¾..."></textarea>
</div>

<div class="status" id="status">å‡†å¤‡å°±ç»ª</div>

<script>
// å®Œå…¨æ”¾å¼ƒES6+è¯­æ³•ï¼Œçº¯ES5é€‚é…iOS12.5.8
var owner = "zhourn";
var repo = "zhourn.github.io";
var path = "note/data.json";
var currentPage = 1;
var pages = {1:"", 2:"", 3:""};

// è·å–DOMèŠ‚ç‚¹ï¼ˆå…¼å®¹è€æ–¹æ³•ï¼‰
var textarea = document.getElementById("note");
var statusTxt = document.getElementById("status");
var tokenInput = document.getElementById("token");
var pageBtns = document.getElementsByClassName("page-btn");
var syncBtn = document.querySelector(".sync-btn");

// åˆå§‹åŒ–
loadLocalData();
renderPage();

// é¡µé¢åˆ‡æ¢ï¼ˆå…¼å®¹è€æµè§ˆå™¨äº‹ä»¶ç»‘å®šï¼‰
for (var i = 0; i < pageBtns.length; i++) {
  if (!pageBtns[i].classList.contains("sync-btn")) {
    pageBtns[i].onclick = function() {
      pages[currentPage] = textarea.value;
      currentPage = this.getAttribute("data-page");
      renderPage();
    };
  }
}

// åŒæ­¥æŒ‰é’®ç‚¹å‡»
syncBtn.onclick = function() {
  pages[currentPage] = textarea.value;
  saveLocalData();
  if (tokenInput.value.trim() === "") {
    statusTxt.innerHTML = "âŒ è¯·è¾“å…¥Token";
    return;
  }
  statusTxt.innerHTML = "ğŸ”„ åŒæ­¥ä¸­...";
  saveToGitHub(tokenInput.value.trim());
};

// è¾“å…¥å®æ—¶æœ¬åœ°ä¿å­˜
textarea.oninput = function() {
  pages[currentPage] = this.value;
  saveLocalData();
};
textarea.onpropertychange = function() { // å…¼å®¹iOS12è€æµè§ˆå™¨inputäº‹ä»¶
  pages[currentPage] = this.value;
  saveLocalData();
};

// æ¸²æŸ“é¡µé¢ï¼ˆåˆ‡æ¢é€‰ä¸­/èµ‹å€¼ï¼‰
function renderPage() {
  textarea.value = pages[currentPage] || "";
  // ç§»é™¤æ‰€æœ‰active
  for (var i = 0; i < pageBtns.length; i++) {
    pageBtns[i].classList.remove("active");
  }
  // ç»™å½“å‰é¡µåŠ active
  var activeBtn = document.querySelector('[data-page="' + currentPage + '"]');
  if (activeBtn) activeBtn.classList.add("active");
}

// æœ¬åœ°ä¿å­˜ï¼ˆå…¼å®¹iOS12 localStorageï¼‰
function saveLocalData() {
  try {
    if (window.localStorage) {
      localStorage.setItem("note_zhourn", JSON.stringify(pages));
    }
  } catch (e) {
    statusTxt.innerHTML = "âš ï¸ æœ¬åœ°ä¿å­˜å¤±è´¥";
  }
}

// åŠ è½½æœ¬åœ°æ•°æ®
function loadLocalData() {
  try {
    if (window.localStorage && localStorage.getItem("note_zhourn")) {
      var localData = localStorage.getItem("note_zhourn");
      pages = JSON.parse(localData);
    }
  } catch (e) {
    pages = {1:"", 2:"", 3:""};
  }
}

// GitHubäº‘ç«¯åŒæ­¥ï¼ˆçº¯XHRï¼Œæ”¾å¼ƒfetchï¼Œå…¼å®¹iOS12ï¼‰
function saveToGitHub(token) {
  // å…ˆè½¬ç å†…å®¹ï¼ˆå…¼å®¹Base64ï¼‰
  var jsonContent = JSON.stringify(pages);
  var base64Content = btoa(unescape(encodeURIComponent(jsonContent)));
  
  // å…ˆè·å–æ–‡ä»¶SHAï¼ˆæ›´æ–°éœ€è¦ï¼‰
  var xhrGet = new XMLHttpRequest();
  xhrGet.open("GET", "https://api.github.com/repos/" + owner + "/" + repo + "/contents/" + path, true);
  xhrGet.setRequestHeader("Authorization", "token " + token);
  xhrGet.onreadystatechange = function() {
    if (xhrGet.readyState === 4) {
      var sha = "";
      if (xhrGet.status === 200) {
        try {
          var res = JSON.parse(xhrGet.responseText);
          sha = res.sha || "";
        } catch (e) {sha = "";}
      }
      // æ‰§è¡Œä¸Šä¼ 
      uploadToGitHub(token, base64Content, sha);
    }
  };
  xhrGet.send();
}

// ä¸Šä¼ åˆ°GitHub
function uploadToGitHub(token, content, sha) {
  var xhrPut = new XMLHttpRequest();
  xhrPut.open("PUT", "https://api.github.com/repos/" + owner + "/" + repo + "/contents/" + path, true);
  xhrPut.setRequestHeader("Authorization", "token " + token);
  xhrPut.setRequestHeader("Content-Type", "application/json");
  
  var postData = {
    "message": "note sync",
    "content": content
  };
  if (sha !== "") {
    postData.sha = sha;
  }
  
  xhrPut.onreadystatechange = function() {
    if (xhrPut.readyState === 4) {
      if (xhrPut.status === 200 || xhrPut.status === 201) {
        statusTxt.innerHTML = "âœ… åŒæ­¥æˆåŠŸ";
      } else {
        statusTxt.innerHTML = "âŒ åŒæ­¥å¤±è´¥ï¼ˆToken/ç½‘ç»œæ£€æŸ¥ï¼‰";
      }
    }
  };
  xhrPut.send(JSON.stringify(postData));
}

// é¡µé¢åŠ è½½å®Œæˆåå°è¯•ä»äº‘ç«¯åŠ è½½
window.onload = function() {
  var token = tokenInput.value.trim();
  if (token !== "") {
    loadFromGitHub(token);
  }
};

// ä»GitHubåŠ è½½æ•°æ®
function loadFromGitHub(token) {
  var xhr = new XMLHttpRequest();
  xhr.open("GET", "https://api.github.com/repos/" + owner + "/" + repo + "/contents/" + path, true);
  xhr.setRequestHeader("Authorization", "token " + token);
  xhr.onreadystatechange = function() {
    if (xhr.readyState === 4 && xhr.status === 200) {
      try {
        var res = JSON.parse(xhr.responseText);
        var decodeContent = decodeURIComponent(escape(atob(res.content)));
        pages = JSON.parse(decodeContent);
        renderPage();
        statusTxt.innerHTML = "âœ… äº‘ç«¯æ•°æ®åŠ è½½å®Œæˆ";
      } catch (e) {
        statusTxt.innerHTML = "âš ï¸ äº‘ç«¯æ•°æ®è§£æå¤±è´¥";
      }
    }
  };
  xhr.send();
}
</script>
</body>
</html>
